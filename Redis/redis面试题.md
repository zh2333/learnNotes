#### 1.使用过redis分布式锁吗

先拿setnx抢锁, 抢到之后再使用expire给锁设置一个过期时间. 如果在setnx之后执行expire之前发生了crash了怎么办?

使用set命令将setnx和expire合并成一条命令执行.



#### 2.假如redis中有一亿个key, 其中有10w个key是以相同的前缀开头的, 如何全部找出来?

使用keys命令可以扫描出指定模式的key列表

如果这个redis正在给线上的业务提供服务, 那么使用keys命令会有什么问题?

redis是单线程的. keys指令会导致线程阻塞一段时间, 线上服务会停顿, 直到该指令执行完成, 服务才能恢复.这个时候可以使用scan命令, scan指令可以无阻塞的提取出指定模式的key列表, 但是会有一定的重复概率, 在客户端做一次去重就行了, 但是整体花费的时间比直接使用keys指令长



#### 3. 使用过redis做异步队列吗, 你是怎么使用的?

一般使用list结构作为队列, rpush生产消息, lpop消费消息. 当lpop没有消息的时候, 要适当sleep一会再重试.

如果不使用sleep呢? list还有一个命令blpop, 在没有消息的时候它会阻塞消息的到来.

能不能生产一次消费多次呢? 在使用pub/sub主题订阅模式时, 可以实现1:N的消息队列.

pub/sub有什么缺点? 在消费者下线的情况下, 生产的消息会丢失, 得使用专业的消息队列如rabbitmq.

redis如何实现延迟队列? 使用sortedset, 拿时间戳作为score, 消息内容作为key调用zadd生产消息, 消费者使用zrangebyscore指令获取N秒之前的数据轮询进行处理.



#### 4.如果有大量的key需要同一时间过期, 一般需要注意什么?

如果大量的key过期时间设置的过于集中, 到过期的那个时间点, redis可能会出现短暂的卡顿现象.一般要加一个随机值, 让过期时间更分散一点.



#### 5.redis如果做持久化?

bgsave做镜像全量持久化, aof做增量持久化. 因为bgsave会耗费较长的时间, 不够实时, 在停机的时候会导致大量的数据丢失, 所以需要使用aof来[诶和使用.在redis实例重启的时候会使用bgsave持久化文件重新构建内存, 再使用aof重放近期的操作指令来实现完整恢复重启之前的状态.

如果突然机器掉电会怎么样? 取决于aof日志sync属性的配置, 如果不要求性能, 在每条写指令时都sync一下磁盘, 就不会丢失数据. 但是在高性能的要求下每次都sync是不现实的, 一般都使用定时sunc, 比如一秒一次, 这个时候至多会丢失一秒的数据

bgsave的原理是什么? fork和cow. fork是指redis通过创建子进程来进行bgsave操作, cow指的是copy on write, 子进程创建后, 父进程共享数据段, 父进程继续提供读写服务, 写脏数据的页面数据会逐渐增加和子进程分离开来.

pipline有什么好处, 为什么要使用pipline? 可以将多次IO往返时间合并为一次, 前提是pipline执行的时间之间没有因果关系. 使用redis-benchmark机型压测的时候可以发现影响redis的QPS峰值的一个重要因素是pipline批次指令的数目.



#### 6.redis的同步机制了解吗?

redis可以使用主从同步, 从从同步. 第一次同步时, 主节点做一次bgsave, 并同时将后续修改操作记录到内存buffer, 待完成后将rdb文件全量同步到复制节点, 复制节点接受完成后将rdb镜像加载到内存. 内存加载完成后再通知主节点将期间修改的操作记录同步到复制节点机型重放就完成了同步过程.



#### 7.是否使用redis集群, 集群的原理是什么?

redis Sentinal着眼于高可用, 在master宕机的时候会自动将slave提升为master, 继续提供服务.

redis Cluster着眼于扩展性, 在单个redis内存不足时使用cluster进行分片存储.



